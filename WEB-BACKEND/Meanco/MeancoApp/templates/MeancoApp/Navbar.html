
<nav class="navbar navbar-inverse navbar-fixed-top" >

  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <a class="navbar-brand" href="/">MEANCO</a>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li ><a >Let's Connect! <span class="sr-only">(current)</span></a></li>
      </ul>

     <form class="navbar-form navbar-left search-form" method="get" action="/Search/" role="search">
          <div class="form-group">
              <input type="text" class="form-control" name="param" placeholder="Search">
          </div>
          <button type="submit" name="action" value="topic" class="btn btn-default">Topic</button>
          <button type="submit" name="action" value="tag" class="btn btn-default">Tag</button>
      </form>
    {% if user.is_authenticated %}
        <div class="btn-group navbar-btn">
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal">Create Topic</button>
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#relationModal">Add Relation</button>
        </div>
    {% endif %}
      <ul class="nav navbar-nav navbar-right">
        {% if user.is_authenticated %}
          <li><a >{{ user.get_username }}<span class="sr-only">(current)</span></a></li>
          <div class="btn-group btn-group-lg">
            <a href="/" class="btn btn-default btn-xs" role="button" >
              <span class="glyphicon glyphicon-wrench"></span>
            </a>
            <a href="{% url 'logout'%}?next={{request.path}}" class="btn btn-danger btn-xs" role="button">
              <span class="glyphicon glyphicon-off" ></span>
            </a>
          </div>
        {% else %}
          <li><a href="{% url 'login'%}?next={{request.path}}"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
          <li><a href="{% url 'signup'%}?next={{request.path}}"><span class="glyphicon glyphicon-user"></span> SignUp</a></li>
        {% endif %}
      </ul>


    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

{% csrf_token %}

<form class="form-horizontal" id="addTopicId" method="post">
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Create Topic</h4>
                    <p id="topicWarningId"></p>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-sm-3" >Topic Name:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="topicName" id="topicNameId">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-3" >Search tag:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="searchTagId">
                            </div>
                        </div>
                        <div class="dropdown resultbottom">
                            <button class="btn btn-primary dropdown-toggle result" type="button" data-toggle="dropdown" id="pickTagId">Pick a tag:
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu result" id="tagListId">
                                <li>None</li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-3" >Tag:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="tag" id="tagLabelId" disabled>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-3" >Description:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="description" id="tagDescriptionId" disabled>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-9">
                                <input type="hidden" class="form-control" name="URL" id="tagURLId">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" id="topicSubmitId" class="btn btn-default">Submit</button>
                </div>
            </div>

        </div>
    </div>
</form>

<script>

    var tags = [];

    function pickTag(id){
        console.log("Tag is picked!");
        console.log("Tag label: " + tags[id].label);
        $("#tagLabelId").replaceWith("<input type=\"text\" class=\"form-control\" name=\"tag\" id=\"tagLabelId\" value=\"" + tags[id].label + "\" readonly=\"readonly\">");
        console.log("Tag description: " + tags[id].description);
        $("#tagDescriptionId").replaceWith("<input type=\"text\" class=\"form-control\" name=\"description\" id=\"tagDescriptionId\" value=\"" + tags[id].description + "\" readonly=\"readonly\">");
        console.log("Tag url: " + tags[id].concepturi);
        $("#tagURLId").replaceWith("<input type=\"hidden\" class=\"form-control\" name=\"URL\" id=\"tagURLId\" value=\"" + tags[id].concepturi + "\">");
    }

    $(document).ready(function () {
        $('#searchTagId').on('change', function(event){
            event.preventDefault();
            tags = [];
            console.log("search form changed!");  // sanity check
            console.log($(this).val());
            $.ajax({
                url: "https://www.wikidata.org/w/api.php?action=wbsearchentities&search="+$(this).val()+"&language=en&format=json",
                type: "get",
                cache: 'false',
                dataType: "jsonp",
                async: 'true',

                success: function(response) {
                    console.log(response);
                    if(response.search.length == 0){
                        console.log("Tag could not be found in wikidata.");
                        $("#topicWarningId").replaceWith("<p class=\"form-control\" id=\"topicWarningId\">Tag could not be found in wikidata.</p>");
                        $("#tagListId").replaceWith("<ul class=\"dropdown-menu\" id=\"tagListId\"><li>None</li></ul>");
                        $("#tagLabelId").replaceWith("<input type=\"text\" class=\"form-control\" name=\"tag\" id=\"tagLabelId\" disabled>");
                        $("#tagDescriptionId").replaceWith("<input type=\"text\" class=\"form-control\" name=\"description\" id=\"tagDescriptionId\" disabled>");
                        $("#tagURLId").replaceWith("<input type=\"hidden\" class=\"form-control\" name=\"URL\" id=\"tagURLId\">");
                    }else{
                        $("#topicWarningId").replaceWith("<p id=\"topicWarningId\"></p>");
                        labels = [];
                        descriptions = [];
                        str = "<ul class=\"dropdown-menu\" id=\"tagListId\">";
                        for (var i in response.search) {
                            if (response.search[i].description) {
                                if(!response.search[i].description.includes("disambiguation")){
                                    tags[i] = response.search[i];
                                    labels[i] = response.search[i].label;
                                    descriptions[i] = response.search[i].description;
                                    str += "<li onclick=\"pickTag(this.id)\" id=\"" + i + "\">" + labels[i] + " (" + descriptions[i] + ")</li>";
                                }else{
                                    console.log("There is a tag with disambiguous description.");
                                    i ++;
                                }
                            }else{
                                console.log("There is a tag without description.");
                                i ++;
                            }
                        }
                        str += "</ul>";
                        $("#tagListId").replaceWith(str);
                    }
                },
                error:function(response){
                    console.log("Error!");
                    console.log(response);
                }
            });

        });
    });

    $(document).ready(function () {
        $('#topicSubmitId').on('click', function(event){
            event.preventDefault();
            console.log("form submission requested...");  // sanity check
            serializedData = $("#addTopicId").serialize();
            console.log("post data: " + serializedData);
            console.log("form submitted!");  // sanity check
            if($("#topicNameId").val().length == 0){
                console.log("Empty label name!");
                $("#topicWarningId").replaceWith("<p class=\"form-control\" id=\"topicWarningId\">Please enter a topic name.</p>");
                return;
            }
            if($("#tagLabelId").val().length == 0){
                console.log("Empty tag field!");
                $("#topicWarningId").replaceWith("<p class=\"form-control\" id=\"topicWarningId\">Please pick a tag.</p>");
                return;
            }
            $.ajax({
                url: "/API/AddTopic",
                type: "post",
                data: serializedData,
                cache: 'false',
                dataType: "json",
                async: 'true',

                success: function(response) {
                    console.log(response);
                    if(response.topicId){
                        console.log("Topic exists now.");
                        location.reload();
                    }else{
                        console.log("Topic cannot be created.");
                        $("#topicWarningId").replaceWith("<p class=\"form-control\" id=\"topicWarningId\">Topic cannot be created.</p>");
                    }
                },
                error: function(response){
                    console.log(response);
                    console.log("Error during topic creation.");
                    console.log(response.responseText);
                    if(response.responseText == "Tag creation error"){
                        console.log("Topic is OK. Tag is NOK.");
                        window.location = "/";
                    }
                }
            });

        });
    });
</script>

<form class="form-horizontal" method="post" id="addRelationId">
    {% csrf_token %}
    <div class="modal fade" id="relationModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add Relation</h4>
                    <p id="relationWarningId"></p>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-sm-3">First Topic:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="startTopicId" name="topicStartPoint" onkeyup="showResult(this.id, this.value)">
                            </div>
                        </div>
                        <div></div>
                        <div>
                            <ul id="livesearch1">
                            <ul>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-9">
                                <input type="hidden" class="form-control" id="id1" value="-1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-3">Second Topic:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="endTopicId" name="topicEndPoint" onkeyup="showResult(this.id, this.value)">
                            </div>
                        </div>
                        <div>
                            <ul id="livesearch2">
                            <ul>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-9">
                                <input type="hidden" class="form-control" id="id2" value="-1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-3" >Relation Name:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="relationLabelId" name="label">
                            </div>
                        </div>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="isBidirectionalId" name="isBidirectional"> Bidirectional
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" id="relationSubmitId" class="btn btn-info">Submit</button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    function pickResult(id, label, searchBoxId){
        console.log("Topic is picked.");
        if(searchBoxId == 1) {
            $('#startTopicId').replaceWith("<input type=\"text\" class=\"form-control\" id=\"startTopicId\" name=\"topicStartPoint\" onkeyup=\"showResult(this.id, this.value)\" value=\"" + label + "\">");
            $('#id1').val(id);
        }else if(searchBoxId == 2){
            $('#endTopicId').replaceWith("<input type=\"text\" class=\"form-control\" id=\"endTopicId\" name=\"topicEndPoint\" onkeyup=\"showResult(this.id, this.value)\" value=\"" + label + "\">");
            $('#id2').val(id);
        }else{
            console.log("Invalid!");
        }
        $('#livesearch' + searchBoxId).replaceWith('<ul id="livesearch' + searchBoxId + '"><ul>');
    }

    function showResult(id, str) {

        if (str.length != 0) {

            if(id == "startTopicId"){
                console.log("No beginning.");
                $('#id1').val(-1);
            }else if(id == "endTopicId"){
                console.log("No ending.");
                $('#id2').val(-1);
            }else{  // Invalid
            }

            $.ajax({
                url: "/API/TopicLister",
                type: "get",
                data: "search=" + str,
                cache: 'false',
                dataType: "json",
                async: 'true',

                success: function(response) {
                    console.log(response);
                    searchBoxId = 0;
                    if(id == "startTopicId"){
                        console.log("StartTopicChoice");
                        searchBoxId = 1;
                    }else if(id == "endTopicId"){
                        console.log("EndTopicChoice");
                        searchBoxId = 2;
                    }else{  // Invalid
                        console.log("Invalid Choice");
                    }
                    result = '<ul class="result" id="livesearch' + searchBoxId + '">';
                    for (var i in response) {
                        label = response[i].fields.label;
                        topicId = response[i].pk;
                        result += '<li onclick="pickResult(' + topicId + ',\'' + label + '\',' + searchBoxId + ')">' + label + '</li>';
                    }
                    result += '</ul>';
                    $('#livesearch' + searchBoxId).replaceWith(result);

                },
                error: function(response){
                    console.log("Error!");
                    console.log(response);
                }
            });
        }
    }

    $(document).ready(function () {
        $('#relationSubmitId').on('click', function(event){
            event.preventDefault();
            console.log("new relations are submitted.");  // sanity check
            direction = 0;
            if($("#isBidirectionalId").prop('checked')){
                direction = 1;
            }
            var serializedData = {
                topic1: $('#id1').val(),
                topic2: $('#id2').val(),
                label: $("#relationLabelId").val(),
                isBidirectional: direction
            };
            console.log("post data: " + serializedData);
            console.log("form submitted!");  // sanity check

            $("#relationWarningId").replaceWith("<p id=\"relationWarningId\"></p>");
            if($("#startTopicId").val().length == 0 || $('#id1').val() == -1){
                console.log("Empty start point topic field!");
                $("#relationWarningId").replaceWith("<p class=\"form-control\" id=\"relationWarningId\">Please choose a topic for the starting point.</p>");
                return;
            }
            if($("#endTopicId").val().length == 0 || $('#id2').val() == -1){
                console.log("Empty end point topic field!");
                $("#relationWarningId").replaceWith("<p class=\"form-control\" id=\"relationWarningId\">Please choose a topic for the end point.</p>");
                return;
            }
            if($("#relationLabelId").val().length == 0){
                console.log("Empty relation label field!");
                $("#relationWarningId").replaceWith("<p class=\"form-control\" id=\"relationWarningId\">Please write the relation between two topics.</p>");
                return;
            }
            $.ajax({
                url: "/API/AddRelation",
                type: "post",
                data: serializedData,
                cache: 'false',
                async: 'true',

                success: function(response) {
                    console.log("No error.");
                    console.log(response);
                    location.reload();
                },
                error: function(response){
                    console.log("Error: AddRelation!");
                    if(response.responseText == "Relation created"){
                        console.log("Relation is created.");
                        location.reload();
                    } else if(response.responseText == "Relation Exists") {
                        console.log("Relation already exists.");
                        $("#relationWarningId").replaceWith("<p class=\"form-control\" id=\"relationWarningId\">Relation already exists.</p>");
                    } else if(response.responseText == "Relation Couldn't be created") {
                        console.log("Relation could not be created.");
                        $("#relationWarningId").replaceWith("<p class=\"form-control\" id=\"relationWarningId\">Relation could not be created.</p>");
                    }
                    console.log(response);
                }
            });

        });
    });
</script>
</div>